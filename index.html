<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>zetmeoOS - V40.4 (Mobile Optimized)</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíñ</text></svg>">

    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-body: #1a1a1a; --bg-box: #242424;
            --main-color: #ff85a2; --text-color: #e0e0e0;
            --accent-blue: #4fc3f7; --accent-green: #81c784;
            --danger: #ff5252; --done-color: #555555;
            --input-bg: #111; --border-color: #333;
            --dark-gray: #555555;
        }

        body.light-mode {
            --bg-body: #ffffff; --bg-box: #f5f5f5;
            --text-color: #333333; --done-color: #999999;
            --input-bg: #ffffff; --border-color: #dddddd;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Quicksand', sans-serif !important; }
        body { background-color: var(--bg-body); color: var(--text-color); margin: 0; padding: 10px 10px 120px 10px; overflow-x: hidden; transition: background 0.3s ease; }

        /* SYNC NOTIFICATIONS */
        #sync-badge, #sync-countdown { position: fixed; top: 15px; right: 15px; z-index: 9999; padding: 8px 16px; border-radius: 25px; font-size: 0.75em; font-weight: 800; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-transform: uppercase; }
        #sync-badge.status-waiting { background: #f1c40f; color: #222; display: flex !important; }
        #sync-badge.status-synced { background: #2ecc71; color: #fff; display: flex !important; }
        #sync-badge.status-local { background: var(--main-color); color: #fff; display: flex !important; }
        #sync-countdown { background: var(--main-color); color: #fff; display: none; border: 2px solid rgba(255,255,255,0.2); }

        /* SESSION 1: RPG HEADER */
        .rpg-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .rpg-box { background: var(--bg-box); border-radius: 20px; padding: 15px; border: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: center; }
        .profile-area { text-align: center; align-items: center; }
        .mascot-img { width: 65px; height: 65px; border-radius: 50%; border: 3px solid var(--main-color); margin-bottom: 8px; object-fit: cover; }
        .level-title { font-weight: 800; color: var(--main-color); font-size: 1.1em; }
        .next-lv-msg { font-size: 0.85em; color: var(--text-color); opacity: 0.7; margin-top: 8px; font-weight: 600; line-height: 1.4; }
        .year-header { font-weight: 800; font-size: 0.95em; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; color: var(--main-color); text-transform: uppercase; }

        /* PROGRESS BARS */
        .progress-bar { background: var(--input-bg); height: 32px; border-radius: 16px; overflow: hidden; width: 100%; position: relative; border: 1px solid var(--border-color); margin-top: 10px; }
        .progress-fill { height: 100%; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); background: linear-gradient(90deg, #ffb1c5 0%, var(--main-color) 100%); }
        .goal-header-inside { position: absolute; width: 100%; height: 100%; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; font-weight: 800; color: #fff; font-size: 1.1em; z-index: 2; pointer-events: none; }
        body.light-mode .goal-header-inside { color: #333; }
        .avatar-xp-bar { height: 20px; border-radius: 10px; margin: 10px 0; width: 85%; }

        /* GUIDE */
        .guide-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .guide-box { background: var(--bg-box); border-radius: 20px; min-height: 130px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 18px; border: 1px solid var(--border-color); position: relative; overflow: hidden; }
        #quote-area { background-size: cover; background-position: center; }
        #quote-area::before { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.75); }
        body.light-mode #quote-area::before { background: rgba(255,255,255,0.85); }
        .quote-text, #lam-msg { position: relative; z-index: 1; font-weight: 800; font-size: 1.1em; line-height: 1.4; color: #fff; }
        body.light-mode .quote-text, body.light-mode #lam-msg { color: #333; }
        .quote-text { font-style: italic; }
        .lam-avatar { font-size: 2em; margin-bottom: 5px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-6px);} }

        /* TASK LIST & TEXTAREA AUTO-WRAP */
        .box { background: var(--bg-box); border-radius: 20px; padding: 18px; margin-bottom: 18px; border: 1px solid var(--border-color); }
        .box-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 12px; }
        .box-title { color: var(--main-color); font-weight: 800; font-size: 1.1em; margin: 0; cursor: pointer; }
        .task-list { list-style: none; padding: 0; margin: 0; min-height: 20px; }
        .task-item { display: flex; align-items: flex-start; padding: 8px 0; }
        .task-item.level-2 { margin-left: 28px; }
        .task-item.level-3 { margin-left: 55px; }
        .custom-cb { appearance: none; -webkit-appearance: none; width: 22px; height: 22px; border: 2px solid var(--main-color); border-radius: 50%; cursor: pointer; position: relative; margin-right: 12px; margin-top: 4px; flex-shrink: 0; }
        .custom-cb:checked { background: var(--main-color); }
        .custom-cb:checked::after { content: "‚úì"; color: white; position: absolute; left: 50%; top: 45%; transform: translate(-50%, -50%); font-size: 13px; font-weight: 900; }
        
        /* MOBILE TEXT WRAP FIX */
        .task-text { 
            flex-grow: 1; border: none; background: transparent; color: var(--text-color); 
            font-size: 1em; padding: 4px; outline: none; width: 100%; font-weight: 600; 
            resize: none; overflow: hidden; height: auto; display: block; line-height: 1.4;
        }
        .task-item.checked .task-text { color: var(--done-color); opacity: 0.6; text-decoration: line-through; }
        .toggle-btn { margin-right: 6px; font-size: 0.7em; color: #666; cursor: pointer; width: 18px; text-align: center; margin-top: 6px; transition: 0.3s; }
        .rotated { transform: rotate(-90deg); display: inline-block; }
        .hidden-task { display: none !important; }

        /* STUDIO */
        .studio-box { background: var(--bg-box); border: 1px solid var(--border-color); border-radius: 20px; padding: 18px; margin-bottom: 22px; border-left: 4px solid var(--main-color); }
        .studio-title { font-weight: 800; color: var(--main-color); font-size: 1.1em; text-transform: uppercase; letter-spacing: 1px; }
        .studio-btn { background: #333; color: #eee; border: none; padding: 7px 14px; border-radius: 8px; font-size: 0.75em; font-weight: 800; cursor: pointer; text-transform: uppercase; }
        .studio-textarea { width: 100%; height: 140px; background: var(--input-bg); color: var(--accent-green); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; font-family: monospace !important; resize: vertical; outline: none; font-size: 15px; }

        /* FOOTER VERSION */
        .footer-version { text-align: center; color: #444; font-size: 9px; font-weight: 700; margin: 30px 0; letter-spacing: 3px; text-transform: uppercase; }

        /* BOTTOM MENU (MINIMALIST) */
        .bottom-menu { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-body); height: 80px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .menu-item { color: var(--dark-gray); cursor: pointer; display: flex; flex-direction: column; align-items: center; border: none; background: none; width: 25%; outline: none; transition: 0.3s; }
        .menu-item svg { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; margin-bottom: 4px; }
        .menu-item.active { color: var(--main-color); }
        .menu-label { font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.96); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 15px; }
        body.light-mode .modal { background: rgba(255,255,255,0.96); }
        .modal-content { background: var(--bg-box); border-radius: 25px; width: 100%; max-width: 950px; height: 92vh; display: flex; flex-direction: column; border: 1px solid var(--border-color); overflow: hidden; }
        
        .tab-btn-group { display: flex; width: 100%; padding: 10px 15px 0 15px; border-bottom: 1px solid var(--border-color); background: rgba(0,0,0,0.2); gap: 5px; }
        .tab-btn { flex: 1; background: none; border: none; color: #666; padding: 15px 5px; font-weight: 800; cursor: pointer; font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; border-radius: 12px 12px 0 0; transition: all 0.3s ease; text-align: center; }
        .tab-btn.active { color: var(--main-color); background: rgba(255, 133, 162, 0.08); border-bottom: 3px solid var(--main-color); }

        .modal-body { flex-grow: 1; padding: 25px; overflow-y: auto; font-size: 17px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block !important; }
        textarea, input { width: 100%; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; font-size: 17px; outline: none; margin-bottom: 15px; font-weight: 600; }
        
        /* 3. MODAL FOOTER BUTTONS (NO SHADOW & CENTERED) */
        .modal-footer { padding: 30px; border-top: 1px solid var(--border-color); display: flex; justify-content: center; align-items: center; gap: 25px; background: var(--bg-body); }
        .modal-footer button { 
            flex: none; min-width: 220px; padding: 18px 35px; font-size: 17px; 
            border-radius: 15px; font-weight: 800; cursor: pointer; 
            box-shadow: none !important; /* REMOVE SHADOW */
            text-transform: uppercase; letter-spacing: 1px; 
        }

        .pink-btn { background: var(--main-color); color: white; border: none; }
        .grey-btn { background: #333; color: #ccc; border: none; }
        body.light-mode .grey-btn { background: #e0e0e0; color: #333; }

        .floating-nav { position: fixed; right: 12px; bottom: 100px; display: flex; flex-direction: column; gap: 10px; z-index: 90; }
        .nav-circle { width: 45px; height: 45px; background: #2a2a2a; border: 1px solid #444; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; cursor: pointer; opacity: 0.8; font-size: 20px; }

        @media (max-width: 600px) { .rpg-container, .guide-container { grid-template-columns: 1fr; } .modal-footer { flex-direction: column; padding: 20px; gap: 15px; } .modal-footer button { width: 100%; min-width: 100%; } }
    </style>
</head>
<body>

    <div id="sync-badge"></div>
    <div id="sync-countdown"></div>
    <canvas id="fireworks" style="position:fixed; inset:0; pointer-events:none; z-index:1999;"></canvas>
    <div id="celeb-popup" style="position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); background: var(--main-color); color: white; padding: 15px 25px; border-radius: 50px; font-weight: 700; z-index: 3000; display: none; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">Yeah! +10 XP</div>

    <div class="rpg-container">
        <div class="rpg-box profile-area">
            <img id="mascot-img" class="mascot-img" src="https://getdrawings.com/free-icon/cat-icon-png-53.png">
            <div id="lv-display" class="level-title">ƒêang t·∫£i...</div>
            <div class="progress-bar avatar-xp-bar"><div id="lv-fill" class="progress-fill" style="width: 0%"></div></div>
            <div id="next-lv-text" class="next-lv-msg">...</div>
        </div>
        <div class="rpg-box">
            <div class="year-header">2026: K·∫æT TINH & C·ªòNG H∆Ø·ªûNG <span id="xp-summary" style="float:right">0/10000 XP</span></div>
            <div id="goals-list"></div>
        </div>
    </div>

    <div class="guide-container">
        <div id="quote-area" class="guide-box"><div id="quote-text" class="quote-text">...</div></div>
        <div class="guide-box">
            <div class="lam-avatar">üë©‚Äçüíº</div>
            <div id="lam-msg">Chi·∫øn th√¥i anh Meo!</div>
        </div>
    </div>

    <div id="taskboard"></div>

    <div class="studio-box">
        <div class="studio-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
            <span class="studio-title">üß† BRAINDOM STUDIO</span>
            <div class="studio-actions" style="display:flex; gap:8px">
                <button class="studio-btn" style="background:var(--main-color); color:white" onclick="saveToStudio('braindom')">L∆∞u</button>
                <button class="studio-btn" onclick="openStudioArchive('braindom')">Kho</button>
            </div>
        </div>
        <textarea id="braindom-input" class="studio-textarea" placeholder="N√©m √Ω t∆∞·ªüng v√†o ƒë√¢y..."></textarea>
    </div>

    <div class="studio-box">
        <div class="studio-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
            <span class="studio-title">‚úçÔ∏è WRITER STUDIO</span>
            <div class="studio-actions" style="display:flex; gap:8px">
                <button class="studio-btn" style="background:var(--main-color); color:white" onclick="saveToStudio('writer')">L∆∞u</button>
                <button class="studio-btn" onclick="openStudioArchive('writer')">Kho</button>
            </div>
        </div>
        <textarea id="writer-input" class="studio-textarea" placeholder="Vi·∫øt nh√°p s√¢u..."></textarea>
    </div>

    <div class="footer-version">ZETMEO OS V40.4 - MASTER STABLE</div>

    <div class="floating-nav">
        <div class="nav-circle" onclick="window.scrollTo({top:0, behavior:'smooth'})">‚ñ≤</div>
        <div class="nav-circle" onclick="window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'})">‚ñº</div>
    </div>

    <div class="bottom-menu">
        <button class="menu-item active" onclick="location.reload()"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span class="menu-label">Home</span></button>
        <button class="menu-item" onclick="syncUp()"><svg viewBox="0 0 24 24"><path d="M12 19v-7m0 0l-3 3m3-3l3 3M12 3a9 9 0 0 0 0 18z"></path></svg><span class="menu-label">Push</span></button>
        <button class="menu-item" onclick="syncDown()"><svg viewBox="0 0 24 24"><path d="M12 5v7m0 0l-3-3m3 3l3-3M12 21a9 9 0 0 0 0-18z"></path></svg><span class="menu-label">Pull</span></button>
        <button class="menu-item" onclick="openAdmin()"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg><span class="menu-label">Admin</span></button>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <div class="tab-btn-group">
                <button class="tab-btn active" id="btn-task" onclick="switchTab('tab-task')">Task Editor</button>
                <button class="tab-btn" id="btn-archive" onclick="switchTab('tab-archive')">Archive</button>
                <button class="tab-btn" id="btn-rpg" onclick="switchTab('tab-rpg')">RPG Config</button>
                <button class="tab-btn" id="btn-fb" onclick="switchTab('tab-fb')">Firebase</button>
            </div>
            <div class="modal-body">
                <div id="tab-task" class="tab-panel active">
                    <label class="sync-label">ƒê·ªìng b·ªô t·ª± ƒë·ªông (ph√∫t)</label>
                    <input type="number" id="auto-sync-min" placeholder="1">
                    <textarea id="task-editor" style="height:400px" spellcheck="false"></textarea>
                    <strong class="sync-label">üïí L·ªãch s·ª≠ phi√™n b·∫£n</strong>
                    <div id="history-container" style="display:flex; flex-direction:column; gap:8px"></div>
                </div>
                <div id="tab-archive" class="tab-panel">
                    <div style="display:flex; gap:10px; margin-bottom:20px; align-items:center">
                        <button class="pink-btn" style="min-width:auto; height:45px; border-radius:12px" onclick="archiveDoneTasks()">üßπ D·ªçn d·∫πp Done</button>
                        <button class="grey-btn" style="min-width:auto; height:45px; border-radius:12px" onclick="exportCSV()">üìä Xu·∫•t CSV</button>
                    </div>
                    <div id="kho-task-list"></div>
                </div>
                <div id="tab-rpg" class="tab-panel">
                    <button class="grey-btn" id="theme-toggle" style="width:100%; margin-bottom:20px" onclick="toggleTheme()">T·∫Øt Night Mode</button>
                    <label class="sync-label">M·ª§C TI√äU | NH√ìM | H·∫†N</label><textarea id="goals-area" style="height:120px"></textarea>
                    <label class="sync-label">LEVEL | PH·∫¶N TH∆Ø·ªûNG</label><textarea id="rewards-area" style="height:100px"></textarea>
                    <label class="sync-label">LEVEL | DANH HI·ªÜU</label><textarea id="levels-area" style="height:100px"></textarea>
                </div>
                <div id="tab-fb" class="tab-panel"><label class="sync-label">FIREBASE URL</label><input type="text" id="fb-db"></div>
            </div>
            <div class="modal-footer"><button class="pink-btn" onclick="saveAll()">L∆ØU T·∫§T C·∫¢</button><button class="grey-btn" onclick="closeAdmin()">ƒê√ìNG</button></div>
        </div>
    </div>

    <div id="studio-archive-modal" class="modal">
        <div class="modal-content">
            <div style="padding:15px; border-bottom:1px solid var(--border-color); font-weight:800; color:var(--main-color)" id="studio-archive-title">KHO STUDIO</div>
            <div class="modal-body" id="studio-archive-list"></div>
            <div class="modal-footer"><button class="grey-btn" style="min-width:200px" onclick="document.getElementById('studio-archive-modal').style.display='none'">ƒê√≥ng</button></div>
        </div>
    </div>

    <div id="note-modal" class="modal">
        <div class="modal-content" style="max-width:500px; height:auto">
            <div style="padding:20px; border-bottom:1px solid var(--border-color); font-weight:700; color:var(--main-color)" id="note-modal-title">Ghi ch√∫</div>
            <div class="modal-body"><textarea id="note-input" style="height:250px"></textarea></div>
            <div class="modal-footer"><button class="pink-btn" style="min-width:150px" onclick="saveNote()">L∆∞u</button><button class="grey-btn" style="min-width:150px" onclick="document.getElementById('note-modal').style.display='none'">ƒê√≥ng</button></div>
        </div>
    </div>

    <script>
        const isMobile = window.matchMedia("(max-width: 768px)").matches || ('ontouchstart' in window);
        const fbConfig = { apiKey: "AIzaSyBvcsIGi-pqjeSFw9Dys0s9gp5K-ZfA7sc", authDomain: "meo-dash-rpg.firebaseapp.com", projectId: "meo-dash-rpg" };

        let totalXP = parseInt(localStorage.getItem('zetmeo_xp_total')) || 0;
        let rpgConfig = JSON.parse(localStorage.getItem('zetmeo_rpg_config')) || { goals: "B√°n h√†ng | Core | 2026", rewards: "5 | Popeyes", levels: "1 | M·∫ßm Xanh Nh·∫£y S·ªë", fbUrl: "", lightMode: false, autoSyncMin: 1 };
        let taskArchive = JSON.parse(localStorage.getItem('zetmeo_task_archive')) || [];
        let studioArchives = JSON.parse(localStorage.getItem('zetmeo_studio_archive')) || { braindom: [], writer: [] };
        let sessionNotes = JSON.parse(localStorage.getItem('zetmeo_notes')) || {};
        let activeNoteSession = "";
        let autoSyncSecs = 0, syncInterval = null;

        function switchTab(tabId) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            const btnId = tabId.replace('tab-', 'btn-');
            document.getElementById(btnId).classList.add('active');
        }

        function startAutoSyncEngine() {
            if(syncInterval) clearInterval(syncInterval);
            const mins = parseInt(rpgConfig.autoSyncMin); if(mins <= 0) return;
            autoSyncSecs = mins * 60;
            syncInterval = setInterval(() => {
                if(document.getElementById('admin-modal').style.display === 'flex') return;
                autoSyncSecs--;
                const countdownEl = document.getElementById('sync-countdown');
                if(autoSyncSecs <= 10 && autoSyncSecs > 0) { countdownEl.style.display='block'; countdownEl.innerText=`‚òÅÔ∏è L∆ØU SAU ${autoSyncSecs}S...`; } else { countdownEl.style.display='none'; }
                if(autoSyncSecs <= 0) { syncUp(true); autoSyncSecs = mins * 60; }
            }, 1000);
        }

        function getDB() { if(!rpgConfig.fbUrl) return null; if(!firebase.apps.length) firebase.initializeApp({...fbConfig, databaseURL: rpgConfig.fbUrl}); return firebase.database(); }
        
        async function syncUp(silent = false) {
            const db = getDB(); if(!db) return silent ? null : alert("C√†i Firebase URL!");
            const badge = document.getElementById('sync-badge');
            if(!silent) { badge.style.display='flex'; badge.className='status-waiting'; badge.innerText = "‚è≥ Pushing..."; }
            try {
                await db.ref('meoOS_V40').set({ dashboard: localStorage.getItem('dashboardData'), xp: totalXP, config: JSON.stringify(rpgConfig), taskArchive: JSON.stringify(taskArchive), studioArchive: JSON.stringify(studioArchives), notes: JSON.stringify(sessionNotes) });
                if(silent) { badge.style.display='flex'; badge.className='status-synced'; badge.innerText="‚òÅÔ∏è Auto-Synced"; setTimeout(()=>badge.style.display='none', 1500); }
                else { badge.innerText="‚úÖ Cloud Synced"; setTimeout(()=>badge.style.display='none', 2000); }
            } catch(e) { if(!silent) alert("Sync l·ªói!"); }
        }

        async function syncDown() {
            const db = getDB(); if(!db) return;
            if(!confirm("T·∫£i d·ªØ li·ªáu m√¢y v·ªÅ?")) return;
            try {
                const snap = await db.ref('meoOS_V40').once('value');
                const val = snap.val();
                if(val) {
                    localStorage.setItem('dashboardData', val.dashboard); localStorage.setItem('zetmeo_xp_total', val.xp);
                    localStorage.setItem('zetmeo_rpg_config', val.config); localStorage.setItem('zetmeo_task_archive', val.taskArchive);
                    localStorage.setItem('zetmeo_studio_archive', val.studioArchive); localStorage.setItem('zetmeo_notes', val.notes);
                    location.reload();
                }
            } catch(e) { alert("Download l·ªói!"); }
        }

        // --- RENDERER (V35.9 ENGINE WITH AUTO-WRAP FIX) ---
        function renderDashboard(val) {
            const board = document.getElementById('taskboard'); board.innerHTML = "";
            val.split(/(?=# )/).forEach(box => {
                const lines = box.split('\n'); if(!lines[0].startsWith('#')) return;
                const title = lines[0].replace('# ', '').trim();
                const boxDiv = document.createElement('div'); boxDiv.className = 'box';
                boxDiv.innerHTML = `<div class="box-header"><h2 class="box-title" onclick="toggleBox(this)">‚ñº ${title}</h2><span class="note-trigger" onclick="openNote('${title}')">üìù</span></div><ul class="task-list"></ul>`;
                const list = boxDiv.querySelector('.task-list');
                lines.slice(1).forEach(line => {
                    if(!line.trim().startsWith('- [')) return;
                    const sp = line.match(/^ */)[0].length, lv = sp >= 4 ? 3 : (sp >= 2 ? 2 : 1);
                    const chk = line.includes('[x]'), txt = line.replace(/^\s*- \[[ x]\] /, '');
                    const li = document.createElement('li'); li.className = `task-item level-${lv} ${chk ? 'checked' : ''}`; li.setAttribute('data-level', lv);
                    li.innerHTML = `<div class="toggle-btn" onclick="toggleFolding(this)">${lv<3?'‚ñº':''}</div><input type="checkbox" class="custom-cb" ${chk?'checked':''} onchange="toggleTask(this,'${title}','${txt.replace(/'/g,"\\'")}')"><textarea class="task-text" oninput="this.style.height='';this.style.height=this.scrollHeight+'px'" onchange="updateDOMToData()">${txt}</textarea>`;
                    list.appendChild(li);
                    // Initial resize
                    setTimeout(() => { const ta = li.querySelector('textarea'); ta.style.height = ta.scrollHeight + 'px'; }, 10);
                });
                board.appendChild(boxDiv);
                new Sortable(list, { group:'shared', animation:150, disabled:isMobile, onEnd:updateDOMToData });
            });
            localStorage.setItem('dashboardData', val);
        }

        function updateRPGUI() {
            const maps = rpgConfig.levels.split('\n').map(l => { const [lv,n]=l.split('|').map(s=>s.trim()); return {lv:parseInt(lv),n}; }).sort((a,b)=>b.lv-a.lv);
            let lv = 1; while(100*Math.pow(lv,1.5)<=totalXP) lv++;
            const title = maps.find(t=>lv>=t.lv)?.n || "Kh·ªüi Nguy√™n", nextL = maps.slice().reverse().find(t=>t.lv>lv) || {lv:lv+1,n:"ƒê·ªânh Cao"};
            const nextXP = Math.ceil(100*Math.pow(lv,1.5)), prevXP = lv===1?0:Math.ceil(100*Math.pow(lv-1,1.5));
            document.getElementById('lv-display').innerText = `Lv. ${lv} - ${title}`;
            document.getElementById('xp-summary').innerText = `${totalXP}/10000 XP`;
            document.getElementById('lv-fill').style.width = `${Math.min(100, ((totalXP-prevXP)/(nextXP-prevXP))*100)}%`;
            document.getElementById('next-lv-text').innerText = `Anh meo ∆°i! C√≤n ${nextXP-totalXP} XP n·ªØa l√† ƒë·∫°t ƒë∆∞·ª£c Lv ${nextL.lv} - ${nextL.n}`;
            const gList = document.getElementById('goals-list'); gList.innerHTML = "";
            rpgConfig.goals.split('\n').forEach(l => {
                const [t,g,time]=l.split('|').map(s=>s.trim()); if(t) {
                    const data = localStorage.getItem('dashboardData')||""; const target = data.split(/(?=# )/).find(b => b.includes('# '+g));
                    let xp = 0; if(target) target.split('\n').forEach(tl => { if(tl.includes('[x]')) xp += (g.toUpperCase().includes('CORE')?10:(g.toUpperCase().includes('FOUNDATION')?8:2.5)); });
                    const per = Math.min(100, (xp / 2000) * 100);
                    gList.innerHTML += `<div class="goal-item"><div class="progress-bar"><div class="goal-header-inside"><span>${t} | ${g}</span><span>${time}</span></div><div class="progress-fill" style="width:${per}%"></div></div></div>`;
                }
            });
        }

        function saveToStudio(type) {
            const v = document.getElementById(type + '-input').value.trim(); if(!v) return;
            const now = new Date(); const ts = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()} - ${now.getHours()}:${now.getMinutes()}`;
            studioArchives[type].unshift({ time: ts, content: v });
            localStorage.setItem('zetmeo_studio_archive', JSON.stringify(studioArchives));
            document.getElementById(type + '-input').value = ""; alert("ƒê√£ v√†o Kho!");
        }

        function openStudioArchive(type) {
            const c = document.getElementById('studio-archive-list'); c.innerHTML = "";
            studioArchives[type].forEach((item, i) => {
                const div = document.createElement('div'); div.className = "archive-item";
                div.innerHTML = `<span class="archive-time">${item.time}</span><textarea id="st-${type}-${i}" class="archive-editor" rows="6">${item.content}</textarea>
                <div style="display:flex; gap:5px"><button class="pink-btn" style="padding:8px 15px; min-width:auto" onclick="navigator.clipboard.writeText(document.getElementById('st-${type}-${i}').value); alert('Copy!')">Copy</button><button class="grey-btn" style="padding:8px 15px; min-width:auto" onclick="studioArchives['${type}'][${i}].content=document.getElementById('st-${type}-${i}').value;localStorage.setItem('zetmeo_studio_archive', JSON.stringify(studioArchives));alert('L∆∞u!')">L∆∞u</button><button class="grey-btn" style="padding:8px 15px; min-width:auto" onclick="studioArchives['${type}'].splice(${i},1);localStorage.setItem('zetmeo_studio_archive', JSON.stringify(studioArchives));openStudioArchive('${type}')">X√≥a</button></div>`;
                c.appendChild(div);
            });
            document.getElementById('studio-archive-modal').style.display = 'flex';
        }

        function archiveDoneTasks() {
            const data = localStorage.getItem('dashboardData'), lines = data.split('\n'); 
            const done = lines.filter(l => l.includes('[x]')), remain = lines.filter(l => !l.includes('[x]'));
            if(!done.length) return alert("Tr·ªëng!");
            done.forEach(t => taskArchive.unshift({ time: new Date().toLocaleString(), text: t.replace(/^\s*- \[x\] /, '').trim() }));
            localStorage.setItem('zetmeo_task_archive', JSON.stringify(taskArchive));
            localStorage.setItem('dashboardData', remain.join('\n')); renderDashboard(remain.join('\n')); renderKhoTask();
        }

        function renderKhoTask() {
            const c = document.getElementById('kho-task-list'), sort = document.getElementById('archive-sort').value;
            let list = [...taskArchive]; if(sort==='oldest') list.reverse();
            c.innerHTML = list.map((t, i) => `<div class="archive-item"><span class="archive-time">${t.time}</span><div style="font-size:14px; margin-bottom:10px">${t.text}</div><button class="pink-btn" style="height:35px; min-width:auto; padding:0 15px" onclick="restoreTask(${i})">Kh√¥i ph·ª•c</button></div>`).join('');
        }

        function restoreTask(i) {
            const t = taskArchive[i]; let data = localStorage.getItem('dashboardData');
            const lines = data.split('\n'); lines.splice(1, 0, `- [ ] ${t.text}`);
            taskArchive.splice(i,1); localStorage.setItem('zetmeo_task_archive', JSON.stringify(taskArchive));
            localStorage.setItem('dashboardData', lines.join('\n')); renderDashboard(lines.join('\n')); renderKhoTask();
        }

        function saveAll() {
            rpgConfig.autoSyncMin = document.getElementById('auto-sync-min').value || 1;
            rpgConfig.goals = document.getElementById('goals-area').value; rpgConfig.rewards = document.getElementById('rewards-area').value;
            rpgConfig.levels = document.getElementById('levels-area').value; rpgConfig.fbUrl = document.getElementById('fb-db').value.trim();
            localStorage.setItem('zetmeo_rpg_config', JSON.stringify(rpgConfig));
            const data = document.getElementById('task-editor').value; localStorage.setItem('dashboardData', data); saveToHistory(data);
            renderDashboard(data); updateRPGUI(); startAutoSyncEngine(); closeAdmin(); 
            // SHOW "ƒê√É L∆ØU" NOTIFICATION
            const badge = document.getElementById('sync-badge');
            badge.innerText = "üíæ ƒê√É L∆ØU C·ª§C B·ªò"; badge.style.display='flex'; badge.className='status-local';
            setTimeout(() => badge.style.display='none', 1500);
        }

        function openAdmin() { 
            document.getElementById('auto-sync-min').value = rpgConfig.autoSyncMin;
            document.getElementById('task-editor').value = localStorage.getItem('dashboardData')||"";
            document.getElementById('goals-area').value = rpgConfig.goals; document.getElementById('rewards-area').value = rpgConfig.rewards;
            document.getElementById('levels-area').value = rpgConfig.levels; document.getElementById('fb-db').value = rpgConfig.fbUrl;
            renderKhoTask(); renderHistory(); document.getElementById('admin-modal').style.display='flex'; 
        }

        function toggleTheme() { rpgConfig.lightMode = !rpgConfig.lightMode; applyTheme(); localStorage.setItem('zetmeo_rpg_config', JSON.stringify(rpgConfig)); }
        function applyTheme() { const btn = document.getElementById('theme-toggle'); if(rpgConfig.lightMode) { document.body.classList.add('light-mode'); if(btn) btn.innerText = "B·∫≠t Night Mode"; } else { document.body.classList.remove('light-mode'); if(btn) btn.innerText = "T·∫Øt Night Mode"; } }
        function toggleTask(cb, box, txt) { const pts = box.toUpperCase().includes('CORE')?10:(box.toUpperCase().includes('FOUNDATION')?8:2.5); const d = localStorage.getItem('dashboardData'), newLines = d.split('\n').map(l => l.includes(txt)?(cb.checked?l.replace('[ ]','[x]'):l.replace('[x]','[ ]')):l); totalXP = cb.checked?totalXP+pts:Math.max(0,totalXP-pts); localStorage.setItem('zetmeo_xp_total', totalXP); renderDashboard(newLines.join('\n')); updateRPGUI(); updateDOMToData(); if(cb.checked) launchFireworks(pts); }
        function updateDOMToData() { let arr = []; document.querySelectorAll('.box').forEach(b => { const t = b.querySelector('.box-title').innerText.replace('‚ñº ','').replace('‚ñ∂ ',''); arr.push(`# ${t}`); b.querySelectorAll('.task-item').forEach(li => { const c = li.querySelector('.custom-cb').checked?'[x]':'[ ]', txt = li.querySelector('.task-text').value, lv = parseInt(li.getAttribute('data-level')), sp = lv===3?'    ':(lv===2?'  ':''); arr.push(`${sp}- ${c} ${txt}`); }); arr.push(""); }); localStorage.setItem('dashboardData', arr.join('\n').trim()); }
        function toggleFolding(btn) { const li = btn.closest('.task-item'), lv = parseInt(li.getAttribute('data-level')), rot = btn.classList.toggle('rotated'); let next = li.nextElementSibling; while(next) { const nLv = parseInt(next.getAttribute('data-level')); if(nLv <= lv) break; if(rot) next.classList.add('hidden-task'); else { next.classList.remove('hidden-task'); const sub = next.querySelector('.toggle-btn'); if(sub && sub.classList.contains('rotated')) { let sLv=nLv, skip=next.nextElementSibling; while(skip && parseInt(skip.getAttribute('data-level')) > sLv) skip=skip.nextElementSibling; next=skip; continue; } } next = next.nextElementSibling; } }
        function openNote(s) { activeNoteSession=s; document.getElementById('note-modal-title').innerText="üìù NOTE: "+s; document.getElementById('note-input').value=sessionNotes[s]||""; document.getElementById('note-modal').style.display='flex'; }
        function saveNote() { sessionNotes[activeNoteSession]=document.getElementById('note-input').value; localStorage.setItem('zetmeo_notes', JSON.stringify(sessionNotes)); document.getElementById('note-modal').style.display='none'; }
        function deleteNote() { if(confirm("X√≥a?")) { delete sessionNotes[activeNoteSession]; localStorage.setItem('zetmeo_notes', JSON.stringify(sessionNotes)); document.getElementById('note-modal').style.display='none'; } }
        function closeAdmin() { document.getElementById('admin-modal').style.display='none'; }
        function renderHistory() { const hist = JSON.parse(localStorage.getItem('zetmeo_history') || "[]"); document.getElementById('history-container').innerHTML = hist.map((h, i) => `<div style="background:var(--input-bg); padding:10px; border-radius:10px; font-size:13px; cursor:pointer; border:1px solid var(--border-color); margin-bottom:5px" onclick="renderDashboard('${h.content.replace(/'/g,"\\'")}')">${h.time} <span style="float:right; color:var(--main-color)">Kh√¥i ph·ª•c</span></div>`).join(''); }
        function saveToHistory(d) { let hist = JSON.parse(localStorage.getItem('zetmeo_history') || "[]"); hist.unshift({ time: new Date().toLocaleString(), content: d }); localStorage.setItem('zetmeo_history', JSON.stringify(hist.slice(0, 5))); }
        function launchFireworks(pts) { const canvas = document.getElementById('fireworks'), ctx = canvas.getContext('2d'); canvas.width=window.innerWidth; canvas.height=window.innerHeight; let parts=[]; for(let i=0;i<40;i++) parts.push({x:canvas.width/2,y:canvas.height/2,vx:(Math.random()-0.5)*12,vy:(Math.random()-0.5)*12,color:`hsl(${Math.random()*360},100%,50%)`,life:1}); function draw() { ctx.clearRect(0,0,canvas.width,canvas.height); parts.forEach((p,i)=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.15;p.life-=0.02;ctx.fillStyle=p.color;ctx.globalAlpha=p.life;ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fill();if(p.life<=0)parts.splice(i,1);}); if(parts.length) requestAnimationFrame(draw); } draw(); const p = document.getElementById('celeb-popup'); p.innerText=`Yeah! +${pts} XP`; p.style.display='block'; setTimeout(()=>p.style.display='none',2500); }
        function exportCSV() { const blob = new Blob([localStorage.getItem('dashboardData')], {type:'text/csv'}); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='tasks.csv'; a.click(); }
        function resetXP() { if(confirm("Reset XP?")) { totalXP=0; localStorage.setItem('zetmeo_xp_total',0); location.reload(); } }
        function toggleBox(el) { const list = el.parentElement.nextElementSibling; list.classList.toggle('hidden-task'); el.innerText = el.innerText.includes('‚ñº')?el.innerText.replace('‚ñº','‚ñ∂'):el.innerText.replace('‚ñ∂','‚ñº'); }

        window.onload = () => { 
            renderDashboard(localStorage.getItem('dashboardData') || "# üéØ CORE\n- [ ] Kh·ªüi ƒë·∫ßu"); updateRPGUI(); applyTheme(); startAutoSyncEngine();
            const quotes = [{text: "S√°ng t·∫°o l√† s·ª± k·∫øt tinh c·ªßa k·ª∑ lu·∫≠t.", author: "Zetmeo"}, {text: "ADHD l√† m·ªôt si√™u nƒÉng l·ª±c.", author: "Lam"}];
            const q = quotes[Math.floor(Math.random() * quotes.length)];
            document.getElementById('quote-text').innerText = `Anh meo ∆°i! "${q.text}" - ${q.author}`;
            document.getElementById('quote-area').style.backgroundImage = "url('https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=800&q=80')";
            const lamLine = (localStorage.getItem('dashboardData') || "").split('\n').find(l => l.trim().startsWith('!!!'));
            if(lamLine) document.getElementById('lam-msg').innerText = lamLine.replace('!!!', '').trim();
        };
    </script>
</body>
</html>
