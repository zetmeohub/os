<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>zetmeoOS - V35.1 (Security Patch)</title>

    <style>
        :root {
            --bg-body: #232323; --bg-box: #2d2d2d;
            --text-main: #fcfcfc; --text-dim: #b0b0b0;
            --main-color: #FF90BC; --sub-1: #FFC0D9; --sub-2: #F9F9E0; --sub-3: #8ACDD7;
            --check-bg: #ABE7B2; --col-urgent: #FF90BC; --col-core: #8ACDD7; --col-found: #FFC0D9; --col-kho: #95a5a6;
        }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Consolas', sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; padding-bottom: 120px; }
        .box { border: 1px solid #444; background-color: var(--bg-box); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 6px solid var(--main-color); }
        h2 { color: var(--main-color); margin-top: 0; border-bottom: 1px dashed #555; }
        
        /* STUDIO STYLES */
        .studio-box { margin-bottom: 20px; border: 2px solid var(--text-dim); border-radius: 12px; padding: 20px; background: rgba(0,0,0,0.2); }
        .studio-textarea { width: 100%; min-height: 150px; background: #111; color: #eee; border: 1px solid #444; padding: 15px; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .studio-btn { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; background: var(--main-color); color: #222; }
        
        .archive-item-card { background: rgba(255,255,255,0.03); border: 1px solid #444; padding: 10px; margin-top: 10px; border-radius: 8px; }
        .archive-item-btns { display: flex; gap: 10px; margin-top: 5px; }
        .mini-btn { background: #444; color: #eee; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }

        /* NAV & MODAL */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #1e1e1e; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #444; }
        .nav-item { background: none; border: none; color: #888; cursor: pointer; text-align: center; }
        
        #edit-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: #2d2d2d; padding: 20px; border-radius: 10px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .setting-field { margin-bottom: 15px; }
        .setting-field label { display: block; font-size: 0.8em; color: var(--sub-3); margin-bottom: 5px; }
        .setting-input { width: 100%; padding: 10px; background: #111; border: 1px solid #555; color: #eee; border-radius: 4px; box-sizing: border-box; }
        
        #toast { visibility: hidden; background: var(--check-bg); color: #333; padding: 16px; position: fixed; left: 50%; bottom: 80px; transform: translateX(-50%); border-radius: 50px; font-weight: bold; }
        #toast.show { visibility: visible; }
    </style>
</head>
<body>

    <div class="box" id="lam-reminder">üë©‚Äçüíº <span id="lam-msg">Ch√†o anh Meo! H√£y d√°n Token m·ªõi v√†o Setting nh√©.</span></div>
    
    <div id="dashboard-container"></div>

    <div class="studio-box">
        <h3>üß† BRAINDOM</h3>
        <textarea id="brain-dump-area" class="studio-textarea" placeholder="Nh·∫≠p nh√°p..."></textarea>
        <button id="braindom-btn" class="studio-btn" onclick="handleStudioSave('braindom')">L∆ØU V√ÄO KHO</button>
        <div id="braindom-archive"></div>
    </div>

    <div class="studio-box">
        <h3>üìñ WRITER</h3>
        <textarea id="book-ideas-area" class="studio-textarea" placeholder="Nh·∫≠p b·∫£n th·∫£o..."></textarea>
        <button id="writer-btn" class="studio-btn" onclick="handleStudioSave('writer')">L∆ØU V√ÄO KHO</button>
        <div id="writer-archive"></div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item" onclick="syncUp()"><span>‚òÅÔ∏è</span><br>Up</button>
        <button class="nav-item" onclick="syncDown()"><span>üå®Ô∏è</span><br>Down</button>
        <button class="nav-item" onclick="openModal()"><span>‚öôÔ∏è</span><br>Setting</button>
    </div>

    <div id="edit-modal">
        <div class="modal-content">
            <h3 style="color:var(--main-color)">‚öôÔ∏è C·∫§U H√åNH H·ªÜ TH·ªêNG</h3>
            
            <div class="setting-field">
                <label>AIRTABLE PERSONAL ACCESS TOKEN (PAT)</label>
                <input type="password" id="set-airtable-pat" class="setting-input" placeholder="D√°n PAT m·ªõi v√†o ƒë√¢y...">
            </div>
            
            <div class="setting-field">
                <label>RECORD ID (D√†nh cho ƒë·ªìng b·ªô Cloud)</label>
                <input type="text" id="set-record-id" class="setting-input" placeholder="recXXXXXXXXXXXXXX">
            </div>

            <div class="setting-field">
                <label>D·ªÆ LI·ªÜU DASHBOARD (MARKDOWN)</label>
                <textarea id="input-data" style="height: 200px;" class="setting-input"></textarea>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="studio-btn" style="background:#444; color:#fff" onclick="closeModal()">ƒê√ìNG</button>
                <button class="studio-btn" onclick="saveSettings()">L∆ØU T·∫§T C·∫¢</button>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        let currentEditingId = null;

        // --- AIRTABLE CONFIG (SAFE VERSION) ---
        function getAirtableConfig() {
            return {
                pat: localStorage.getItem('zetmeo_pat') || '',
                recordId: localStorage.getItem('zetmeo_cloud_record_id') || '',
                url: `https://api.airtable.com/v0/app9cWP64Qbz0T1QT/tbluPfLWGE5oHVOqX`
            };
        }

        // --- STUDIO LOGIC ---
        function handleStudioSave(type) {
            const area = type === 'braindom' ? document.getElementById('brain-dump-area') : document.getElementById('book-ideas-area');
            const content = area.value.trim();
            if (!content) return;

            const key = `zetmeo_${type}_list`;
            let data = JSON.parse(localStorage.getItem(key) || "[]");

            if (currentEditingId) {
                data = data.map(i => i.id === currentEditingId ? {...i, content, date: new Date().toLocaleString()} : i);
                currentEditingId = null;
                document.getElementById(`${type}-btn`).innerText = "L∆ØU V√ÄO KHO";
            } else {
                data.unshift({ id: Date.now(), content, date: new Date().toLocaleString() });
            }

            localStorage.setItem(key, JSON.stringify(data));
            area.value = "";
            renderArchive(type);
            showToast("ƒê√£ xong!");
        }

        function renderArchive(type) {
            const data = JSON.parse(localStorage.getItem(`zetmeo_${type}_list`) || "[]");
            document.getElementById(`${type}-archive`).innerHTML = data.map(i => `
                <div class="archive-item-card">
                    <div style="white-space:pre-wrap">${i.content}</div>
                    <div class="archive-item-btns">
                        <button class="mini-btn" onclick="editItem('${i.id}', '${type}')">‚úèÔ∏è S·ª≠a</button>
                        <button class="mini-btn" onclick="deleteItem('${i.id}', '${type}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function editItem(id, type) {
            const data = JSON.parse(localStorage.getItem(`zetmeo_${type}_list`) || "[]");
            const item = data.find(i => i.id == id);
            if (item) {
                const area = type === 'braindom' ? document.getElementById('brain-dump-area') : document.getElementById('book-ideas-area');
                area.value = item.content;
                currentEditingId = parseInt(id);
                document.getElementById(`${type}-btn`).innerText = "C·∫¨P NH·∫¨T üöÄ";
                area.focus();
            }
        }

        function deleteItem(id, type) {
            if(!confirm("X√≥a?")) return;
            const key = `zetmeo_${type}_list`;
            let data = JSON.parse(localStorage.getItem(key) || "[]");
            localStorage.setItem(key, JSON.stringify(data.filter(i => i.id != id)));
            renderArchive(type);
        }

        // --- SETTINGS ---
        function openModal() {
            document.getElementById('set-airtable-pat').value = localStorage.getItem('zetmeo_pat') || '';
            document.getElementById('set-record-id').value = localStorage.getItem('zetmeo_cloud_record_id') || '';
            document.getElementById('input-data').value = localStorage.getItem('dashboardData') || '';
            document.getElementById('edit-modal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
        
        function saveSettings() {
            localStorage.setItem('zetmeo_pat', document.getElementById('set-airtable-pat').value);
            localStorage.setItem('zetmeo_cloud_record_id', document.getElementById('set-record-id').value);
            localStorage.setItem('dashboardData', document.getElementById('input-data').value);
            renderDashboard(document.getElementById('input-data').value);
            closeModal();
            showToast("ƒê√£ l∆∞u c·∫•u h√¨nh!");
        }

        // --- SYNC ---
        async function syncUp() {
            const config = getAirtableConfig();
            if (!config.pat || !config.recordId) return alert("Thi·∫øu c·∫•u h√¨nh Airtable trong Setting!");
            
            fetch(`${config.url}/${config.recordId}`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${config.pat}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ fields: { "Data": JSON.stringify(localStorage) } })
            }).then(r => r.ok ? showToast("‚òÅÔ∏è ƒê√£ Up!") : alert("L·ªói Sync Up"));
        }

        async function syncDown() {
            const config = getAirtableConfig();
            if (!config.pat || !config.recordId) return alert("Thi·∫øu c·∫•u h√¨nh Airtable trong Setting!");

            fetch(`${config.url}/${config.recordId}`, {
                headers: { 'Authorization': `Bearer ${config.pat}` }
            }).then(r => r.json()).then(d => {
                if (d.fields && d.fields.Data) {
                    const l = JSON.parse(d.fields.Data);
                    Object.keys(l).forEach(k => localStorage.setItem(k, l[k]));
                    location.reload();
                }
            });
        }

        function renderDashboard(text) {
            const container = document.getElementById('dashboard-container');
            container.innerHTML = text.split('\n').map(line => {
                if (line.startsWith('!!!')) { document.getElementById('lam-msg').innerText = line.replace('!!!',''); return ''; }
                if (line.startsWith('#')) return `<h2 style="margin-top:20px">${line.replace('#','')}</h2>`;
                if (line.startsWith('-')) return `<div style="margin-bottom:5px"> <input type="checkbox"> ${line.replace('-','')}</div>`;
                return '';
            }).join('');
        }

        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.className="show"; setTimeout(()=>t.className="", 2000); }

        window.onload = () => {
            renderDashboard(localStorage.getItem('dashboardData') || "# üöÄ DASHBOARD M·ªöI");
            renderArchive('braindom');
            renderArchive('writer');
        };
    </script>
</body>
</html>
